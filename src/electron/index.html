<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TMMARC Meshtastic APRS Gateway (TMAG)</title>
    <link rel="stylesheet" href="./styles.css" />
    <script defer src="../../node_modules/chart.js/dist/chart.umd.js"></script>
  </head>
  <body>
    <main>
      <header>
        <h1 id="app-name">TMMARC Meshtastic APRS Gateway (TMAG) <span class="app-version" id="app-version"></span></h1>
        <p class="subtitle">即時監看 TMAG 的節點流量、遙測封包與 CallMesh 狀態。</p>
      </header>

      <nav class="main-nav">
        <button class="nav-btn active" data-target="monitor-page">監視</button>
        <button class="nav-btn" data-target="messages-page">訊息</button>
        <button class="nav-btn" data-target="telemetry-page">遙測數據</button>
        <button class="nav-btn" data-target="flow-page">Mapping 封包追蹤</button>
        <button class="nav-btn" data-target="nodes-page">節點資料庫</button>
        <button class="nav-btn" data-target="settings-page">設定</button>
        <button class="nav-btn" data-target="info-page">資訊</button>
        <button class="nav-btn" data-target="log-page">Log</button>
      </nav>

      <section id="monitor-page" class="page active">
        <section class="connection-panel">
          <form id="connection-form">
            <div class="button-row">
              <button type="submit" id="connect-btn">連線</button>
              <button type="button" id="open-settings-btn" class="link-button">設定</button>
            </div>
          </form>
          <div id="current-node-display" class="current-node-display hidden">
            <span class="current-node-icon">🛰️</span>
            <span id="current-node-text" class="current-node-text">尚未取得節點資訊</span>
          </div>
          <div class="summary-counters">
            <div class="summary-counter">
              <span class="summary-counter-label">10分鐘封包</span>
              <span id="counter-packages-10min" class="summary-counter-value">0</span>
            </div>
            <div class="summary-counter">
              <span class="summary-counter-label">已上傳 APRS</span>
              <span id="counter-aprs-uploaded" class="summary-counter-value">0</span>
            </div>
            <div class="summary-counter">
              <span class="summary-counter-label">Mapping 節點</span>
              <span id="counter-mapping-count" class="summary-counter-value">0</span>
            </div>
          </div>
          <div class="status-group">
            <div id="status-indicator" class="status status-idle">尚未連線</div>
            <div id="platform-status" class="platform-status"></div>
            <div id="aprs-status" class="aprs-status">APRS: 未連線</div>
            <div id="aprs-server-label" class="aprs-server">Server: —</div>
          </div>
        </section>

        <section class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>時間</th>
                <th>節點</th>
                <th>最後轉發</th>
                <th>Ch</th>
                <th>SNR</th>
                <th>RSSI</th>
                <th>類型</th>
                <th>Hops</th>
                <th>資訊</th>
              </tr>
            </thead>
            <tbody id="packet-table"></tbody>
          </table>
        </section>
      </section>

      <section id="messages-page" class="page hidden">
        <section class="messages-panel">
          <header class="messages-header">
            <h2>訊息頻道</h2>
            <p class="messages-subtitle">
              快速查看 TMAG 預設的對講頻道代號，協助團隊用同一套頻率規則溝通。
            </p>
          </header>
          <div class="messages-layout">
            <aside id="channel-nav" class="channel-nav"></aside>
            <section class="channel-content">
              <header class="channel-content-header">
                <h3 id="channel-title">Primary Channel (CH0)</h3>
                <p id="channel-note">日常主要通訊頻道</p>
              </header>
              <div id="channel-message-list" class="channel-messages">
                <div class="channel-message-empty">尚未收到訊息</div>
              </div>
              <footer id="channel-pagination" class="channel-pagination hidden">
                <div id="channel-pagination-info" class="channel-pagination-info">顯示 0-0，共 0 筆訊息</div>
                <div class="channel-pagination-controls">
                  <button id="channel-page-first" type="button" class="channel-page-btn" disabled>«</button>
                  <button id="channel-page-prev" type="button" class="channel-page-btn" disabled>‹</button>
                  <span class="channel-page-status">
                    第 <span id="channel-pagination-current">1</span> / <span id="channel-pagination-total">1</span> 頁
                  </span>
                  <button id="channel-page-next" type="button" class="channel-page-btn" disabled>›</button>
                  <button id="channel-page-last" type="button" class="channel-page-btn" disabled>»</button>
                  <label class="channel-page-size">
                    每頁
                    <select id="channel-page-size">
                      <option value="25" selected>25</option>
                      <option value="50">50</option>
                      <option value="100">100</option>
                    </select>
                    筆
                  </label>
                </div>
              </footer>
            </section>
          </div>
        </section>
      </section>

      <section id="telemetry-page" class="page hidden">
        <section class="telemetry-panel">
          <header class="telemetry-header">
            <div class="telemetry-controls">
              <label for="telemetry-node-input">節點</label>
              <input
                id="telemetry-node-input"
                type="search"
                placeholder="輸入節點 Mesh ID 或搜尋關鍵字"
                autocomplete="off"
              />
              <div id="telemetry-node-dropdown" class="telemetry-node-dropdown hidden"></div>
            </div>
            <div class="telemetry-chart-controls">
              <label for="telemetry-chart-mode">圖表</label>
              <select id="telemetry-chart-mode">
                <option value="all">所有圖表</option>
                <option value="single">單一圖表</option>
              </select>
              <select id="telemetry-chart-metric" class="hidden"></select>
            </div>
            <div class="telemetry-range-controls">
              <label for="telemetry-range-select">範圍</label>
              <select id="telemetry-range-select">
                <option value="hour1">近 1 小時</option>
                <option value="hour3">近 3 小時</option>
                <option value="hour6">近 6 小時</option>
                <option value="hour12">近 12 小時</option>
                <option value="day">近 24 小時</option>
                <option value="week">近 7 天</option>
                <option value="month">近 30 天</option>
                <option value="year">近 1 年</option>
                <option value="custom">自訂區間</option>
              </select>
              <div id="telemetry-range-custom" class="telemetry-range-custom hidden">
                <input type="datetime-local" id="telemetry-range-start" />
                <span class="telemetry-range-separator">至</span>
                <input type="datetime-local" id="telemetry-range-end" />
              </div>
            </div>
            <div class="telemetry-updated">
              <span class="label">更新：</span>
              <span id="telemetry-updated-at">—</span>
            </div>
            <div class="telemetry-stats">
              <div class="telemetry-stat">
                <span class="label">筆數</span>
                <span id="telemetry-stats-records" class="telemetry-stat-value">0</span>
              </div>
              <div class="telemetry-stat">
                <span class="label">節點</span>
                <span id="telemetry-stats-nodes" class="telemetry-stat-value">0</span>
              </div>
              <div class="telemetry-stat">
                <span class="label">檔案</span>
                <span id="telemetry-stats-disk" class="telemetry-stat-value">—</span>
              </div>
            </div>
            <div class="telemetry-actions">
              <button type="button" id="telemetry-download-btn" class="telemetry-download-btn">
                下載 CSV
              </button>
              <button type="button" id="telemetry-clear-btn" class="danger-btn slim">
                清空遙測數據
              </button>
            </div>
          </header>
          <div id="telemetry-empty-state" class="telemetry-empty">尚未收到遙測資料。</div>
          <section id="telemetry-charts" class="telemetry-charts hidden"></section>
          <section id="telemetry-table-wrapper" class="telemetry-table-wrapper hidden">
            <table class="telemetry-table">
              <thead>
                <tr>
                  <th>時間</th>
                  <th>節點</th>
                  <th>主要數據</th>
                  <th>其他資訊</th>
                </tr>
              </thead>
              <tbody id="telemetry-table-body"></tbody>
            </table>
            <div id="telemetry-pagination" class="telemetry-pagination hidden">
              <div id="telemetry-pagination-info" class="telemetry-pagination-info">—</div>
              <div class="telemetry-pagination-controls">
                <button type="button" id="telemetry-page-first" class="telemetry-page-btn" aria-label="第一頁">«</button>
                <button type="button" id="telemetry-page-prev" class="telemetry-page-btn" aria-label="上一頁">‹</button>
                <span class="telemetry-page-status">
                  第 <span id="telemetry-pagination-current">1</span> / <span id="telemetry-pagination-total">1</span> 頁
                </span>
                <button type="button" id="telemetry-page-next" class="telemetry-page-btn" aria-label="下一頁">›</button>
                <button type="button" id="telemetry-page-last" class="telemetry-page-btn" aria-label="最後一頁">»</button>
                <label class="telemetry-page-size">
                  每頁
                  <select id="telemetry-page-size" class="telemetry-page-size-select"></select>
                </label>
              </div>
            </div>
          </section>
        </section>
      </section>

      <section id="nodes-page" class="page hidden">
        <section class="nodes-panel">
          <header class="nodes-header">
            <div>
              <h2>節點資料庫</h2>
              <p class="nodes-subtitle">顯示目前快取的 Mesh 節點資訊。</p>
            </div>
            <div class="nodes-actions">
              <span class="nodes-count">節點數：<strong id="nodes-total-count">0</strong></span>
              <span class="nodes-online">線上 (1 小時內)：<strong id="nodes-online-count">0</strong><span id="nodes-online-total" class="nodes-online-total"></span></span>
              <button type="button" id="nodes-clear-btn" class="danger-btn slim">清除節點資料庫</button>
            </div>
          </header>
          <div class="nodes-search-row">
            <input id="nodes-search" type="search" placeholder="搜尋節點名稱、Mesh ID 或角色" />
          </div>
          <small id="nodes-status" class="discover-status"></small>
          <div id="nodes-empty-state" class="nodes-empty">目前沒有節點資料。</div>
          <section id="nodes-table-wrapper" class="table-wrapper hidden">
            <table class="nodes-table">
              <thead>
                <tr>
                <th>節點</th>
                <th>Mesh ID</th>
                <th>型號</th>
                <th>角色</th>
                <th>座標</th>
                <th>距離</th>
                <th>最後出現</th>
              </tr>
            </thead>
            <tbody id="nodes-table-body"></tbody>
          </table>
          </section>
        </section>
      </section>

      <section id="settings-page" class="page hidden">
        <section class="settings-panel">
          <h2>連線與 CallMesh 設定</h2>
          <div class="fieldset">
            <label for="connection-mode">連線模式</label>
            <select id="connection-mode">
              <option value="tcp">TCP（網路）</option>
              <option value="serial">Serial（USB）</option>
            </select>
          </div>
          <div class="fieldset hidden" id="serial-settings-block">
            <label for="serial-device-select">Serial 裝置</label>
            <div class="host-row">
              <select id="serial-device-select">
                <option value="">請選擇 Serial 裝置</option>
              </select>
              <button type="button" id="serial-refresh-btn">重新整理</button>
            </div>
            <small class="callmesh-hint">若列表為空，請確認裝置已連線後再按重新整理。</small>
            <small id="serial-status" class="discover-status"></small>
          </div>
          <div class="fieldset" id="settings-host-fieldset">
            <label for="settings-host" id="settings-host-label">Meshtastic 目標</label>
            <div class="host-row">
              <input
                id="settings-host"
                name="settingsHost"
                type="text"
                placeholder="輸入節點 IP"
                required
              />
              <button type="button" id="discover-btn">自動搜尋</button>
            </div>
            <small class="callmesh-hint" id="settings-host-hint">
              TCP 模式輸入 IP（例如 192.168.1.50）；Serial 模式請從上方清單選擇裝置，系統會自動套用。
            </small>
            <small id="discover-status" class="discover-status"></small>
          </div>
          <div class="fieldset callmesh-group">
            <label for="api-key">CallMesh API Key</label>
            <div class="callmesh-row">
              <input id="api-key" name="apiKey" type="password" placeholder="輸入後按儲存" />
              <button type="button" id="save-api-key">儲存</button>
            </div>
            <small class="callmesh-hint">Key 會保存在本機設定檔</small>
          </div>
          <div class="fieldset">
            <label for="aprs-server">APRS 伺服器地址</label>
            <input id="aprs-server" type="text" value="asia.aprs2.net" />
            <small class="callmesh-hint">預設為 asia.aprs2.net，可依需求調整</small>
          </div>
          <div class="fieldset">
            <label for="aprs-beacon-interval">APRS 信標間隔（分鐘）</label>
            <input id="aprs-beacon-interval" type="number" min="1" max="1440" value="10" />
            <small class="callmesh-hint">預設每 10 分鐘發送一次，可調整為 1-1440 分鐘</small>
          </div>
          <div class="fieldset">
            <label class="toggle-row">
              <input id="web-ui-enabled" type="checkbox" />
              <span>啟用 Web UI</span>
            </label>
            <small class="callmesh-hint">預設關閉，啟用後會啟動內建 Web Dashboard</small>
          </div>
          <div class="fieldset tenman-privacy">
            <label class="toggle-row">
              <input id="tenman-share-enabled" type="checkbox" checked />
              <span class="muted-text">允許與 TenManMap 及合作夥伴分享資料</span>
            </label>
            <small class="callmesh-hint muted-hint">不建議停用，僅在特殊需求時取消。</small>
          </div>
          <button type="button" id="reset-data-btn" class="danger-btn">重置所有資料</button>
        </section>
      </section>

      <section id="log-page" class="page hidden">
        <section class="log-panel">
          <h2>系統日誌</h2>
          <p>顯示 Meshtastic Monitor 與 CallMesh 互動的偵錯資訊。</p>
          <div class="log-filter-row">
            <input id="log-search" type="search" placeholder="搜尋 Tag 或內容" />
            <select id="log-tag-filter">
              <option value="all">全部 Tag</option>
              <option value="CALLMESH">CALLMESH</option>
              <option value="APRS">APRS</option>
              <option value="CONNECT">CONNECT</option>
              <option value="TENMAN">TENMAN</option>
              <option value="STATUS">STATUS</option>
              <option value="SUMMARY">SUMMARY</option>
              <option value="SELF">SELF</option>
              <option value="PROVISION">PROVISION</option>
              <option value="NODE-DB">NODE-DB</option>
              <option value="DISCOVER">DISCOVER</option>
              <option value="APP">APP</option>
              <option value="DISCONNECT">DISCONNECT</option>
            </select>
          </div>
          <button type="button" id="copy-log-btn" class="copy-log-btn">複製全部日誌</button>
          <button type="button" id="download-log-btn" class="copy-log-btn">下載日誌</button>
          <pre id="log-output" class="log-output">尚未載入任何紀錄。</pre>
        </section>
      </section>

      <section id="flow-page" class="page hidden">
        <section class="flow-panel">
          <header class="flow-header">
            <h2>Mapping 封包追蹤</h2>
            <p class="flow-panel-hint">僅顯示具 mapping 的位置封包；若同步至 APRS 會附上上傳內容。</p>
            <div class="flow-search-row">
              <input id="flow-search" type="search" placeholder="搜尋節點、Mapping 或 CallSign" />
              <select id="flow-filter-state">
                <option value="all">全部封包</option>
                <option value="aprs">已上傳 APRS</option>
                <option value="pending">待上傳</option>
              </select>
              <button id="flow-download-btn" type="button" class="flow-download-btn">下載記錄</button>
            </div>
          </header>
          <div id="flow-empty-state" class="flow-empty-state">尚未收到封包。</div>
          <div id="flow-list" class="flow-items hidden"></div>
        </section>
      </section>

      <section id="info-page" class="page hidden">
        <section class="info-panel">
          <h2>自動派發資訊</h2>
          <p>顯示 CallMesh 自動下發的設定，並在更新時即時同步。</p>
          <div class="info-grid">
            <div class="info-item">
              <span class="label">呼號</span>
              <span id="info-callsign" class="value">—</span>
            </div>
            <div class="info-item">
              <span class="label">符號</span>
              <span id="info-symbol" class="value">—</span>
            </div>
            <div class="info-item">
              <span class="label">座標</span>
              <span id="info-coords" class="value">—</span>
            </div>
            <div class="info-item">
              <span class="label">輸出功率</span>
              <span id="info-phg-power" class="value">—</span>
            </div>
            <div class="info-item">
              <span class="label">天線高度</span>
              <span id="info-phg-height" class="value">—</span>
            </div>
            <div class="info-item">
              <span class="label">天線增益</span>
              <span id="info-phg-gain" class="value">—</span>
            </div>
            <div class="info-item">
              <span class="label">備註</span>
              <span id="info-comment" class="value multiline">—</span>
            </div>
            <div class="info-item">
              <span class="label">最後更新</span>
              <span id="info-updated-at" class="value">—</span>
            </div>
          </div>
        </section>
      </section>
    </main>

    <template id="packet-row-template">
      <tr>
        <td class="time"></td>
        <td class="nodes"></td>
        <td class="relay"></td>
        <td class="channel"></td>
        <td class="snr"></td>
        <td class="rssi"></td>
        <td class="type"></td>
        <td class="hops"></td>
        <td class="detail">
          <div class="detail-main"></div>
          <div class="detail-extra"></div>
        </td>
      </tr>
    </template>

    <div id="callmesh-overlay" class="overlay hidden">
      <div class="overlay-content">
        <div id="overlay-step-api" class="overlay-step">
          <h2>需要輸入 CallMesh API Key</h2>
          <p>系統偵測到目前尚未設定 API Key，請輸入正確的 Key 並按下「驗證並儲存」完成設定。</p>
          <div class="overlay-input-group">
            <input id="overlay-api-key" type="password" placeholder="輸入 CallMesh API Key" />
            <button id="overlay-save">驗證並儲存</button>
          </div>
          <div id="overlay-status" class="overlay-status"></div>
          <button id="overlay-retry">重新驗證</button>
        </div>
        <div id="overlay-step-host" class="overlay-step hidden">
          <h2>設定 Meshtastic 連線</h2>
          <p>請輸入節點 IP，或在 Serial 模式下從清單選擇裝置（Serial 模式不支援自動搜尋）。</p>
          <div class="overlay-input-group">
            <label for="overlay-connection-mode">連線模式</label>
            <select id="overlay-connection-mode">
              <option value="tcp">TCP（網路）</option>
              <option value="serial">Serial（USB）</option>
            </select>
          </div>
          <div class="overlay-input-group add-gap hidden" id="overlay-serial-block">
            <label for="overlay-serial-select">Serial 裝置</label>
            <div class="overlay-host-actions">
              <select id="overlay-serial-select">
                <option value="">請選擇 Serial 裝置</option>
              </select>
              <button id="overlay-serial-refresh">重新整理</button>
            </div>
            <div id="overlay-serial-status" class="overlay-status"></div>
          </div>
          <div class="overlay-input-group add-gap" id="overlay-host-group">
            <input id="overlay-host" type="text" placeholder="例如：192.168.1.50" />
            <div class="overlay-host-actions">
              <button id="overlay-apply-host">儲存連線設定</button>
              <button id="overlay-discover-host">自動搜尋</button>
            </div>
          </div>
          <div id="overlay-host-status" class="overlay-status"></div>
        </div>
      </div>
    </div>
    <div id="discover-modal" class="modal hidden">
      <div class="modal-content">
        <h2>選擇 Meshtastic 裝置</h2>
        <div id="discover-modal-body" class="modal-body"></div>
        <div class="modal-actions">
          <button id="discover-modal-cancel">取消</button>
        </div>
      </div>
    </div>
    <div id="relay-hint-modal" class="modal hidden">
      <div class="modal-content relay-hint-modal">
        <div class="relay-hint-header">
          <div class="relay-hint-icon">❔</div>
          <div class="relay-hint-title">
            <h2>推測的最後轉發節點</h2>
            <p id="relay-hint-subtitle" class="relay-hint-subtitle">節點資訊可能不完全準確</p>
          </div>
        </div>
        <div class="modal-body relay-hint-body">
          <p id="relay-hint-reason" class="relay-hint-reason">—</p>
          <dl class="relay-hint-meta">
            <div>
              <dt>節點</dt>
              <dd id="relay-hint-node">—</dd>
            </div>
            <div>
              <dt>Mesh ID</dt>
              <dd id="relay-hint-mesh">—</dd>
            </div>
          </dl>
        </div>
        <div class="modal-actions">
          <button id="relay-hint-close">了解</button>
        </div>
      </div>
    </div>
    <script src="./renderer.js"></script>
  </body>
</html>
