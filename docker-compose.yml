version: "3.9"

services:
  callmesh-client:
    container_name: callmesh-client
    image: callmesh-client:latest
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      CALLMESH_API_KEY: "${CALLMESH_API_KEY}"
      CALLMESH_ARTIFACTS_DIR: "/data/callmesh"
      CALLMESH_VERIFICATION_FILE: "/data/callmesh/monitor.json"
      TMAG_WEB_DASHBOARD: "${TMAG_WEB_DASHBOARD:-1}"
      TMAG_TIMEZONE: "${TMAG_TIMEZONE:-Asia/Taipei}"
      TENMAN_DISABLE: "${TENMAN_DISABLE:-0}"
      AUTO_UPDATE: "${AUTO_UPDATE:-1}"
      AUTO_UPDATE_REPO: "${AUTO_UPDATE_REPO:-https://github.com/toodi0418/CMClient.git}"
      AUTO_UPDATE_BRANCH: "${AUTO_UPDATE_BRANCH:-main}"
      AUTO_UPDATE_WORKDIR: "${AUTO_UPDATE_WORKDIR:-/data/callmesh/app-src}"
      AUTO_UPDATE_POLL_SECONDS: "${AUTO_UPDATE_POLL_SECONDS:-300}"
    volumes:
      - callmesh-data:/data/callmesh
    ports:
      - "${TMAG_WEB_PORT:-7080}:7080"
    command:
      - "npm"
      - "start"
      - "--"
      - "--host"
      - "${MESHTASTIC_HOST:-meshtastic.local}"
      - "--port"
      - "${MESHTASTIC_PORT:-4403}"

volumes:
  callmesh-data:
